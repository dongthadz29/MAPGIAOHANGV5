<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Delivery Map Mobile App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Dexie (IndexedDB) -->
  <script src="https://unpkg.com/dexie@3.2.4/dist/dexie.min.js"></script>

  <style>
    html, body { margin:0; padding:0; height:100%; }
    body { overflow:hidden; font-family: system-ui, sans-serif; background:#f5f6f8; position:fixed; width:100%; height:100%; }
    #map { height:100vh; width:100vw; position:fixed; inset:0; z-index:1; }

    .ui-layer {
      position: fixed;
      right: max(16px, env(safe-area-inset-right));
      bottom: max(16px, env(safe-area-inset-bottom));
      display:flex;
      flex-direction:column;
      gap:12px;
      z-index:3000;
      pointer-events:auto;
      transform: translateZ(0);
    }

    .ui-layer button {
      width:56px; height:56px;
      border-radius:50%;
      font-size:20px;
      border:none;
      background:#2563eb;
      color:#fff;
      box-shadow:0 4px 12px rgba(0,0,0,.25);
    }

    .bottom-sheet {
      position: fixed;
      left:0; right:0; bottom:0;
      background:#fff;
      border-radius:16px 16px 0 0;
      padding:16px;
      box-shadow:0 -4px 16px rgba(0,0,0,.25);
      z-index:2500;
      max-height:70%;
      overflow:auto;
    }

    .hidden { display:none; }

    .sheet-input {
      width:100%;
      padding:12px;
      font-size:16px;
      margin-bottom:12px;
      border-radius:8px;
      border:1px solid #ccc;
    }

    .sheet-actions { display:flex; gap:12px; }
    .sheet-actions button { flex:1; padding:14px; font-size:16px; border:none; border-radius:10px; }
    .btn-save { background:#2563eb; color:#fff; }
    .btn-cancel { background:#e5e7eb; }

    .list-item { padding:12px; border-bottom:1px solid #eee; }
    .list-item b { display:block; }
    .list-actions button { margin-right:8px; padding:6px 10px; border:none; border-radius:6px; background:#e5e7eb; }

    .search-bar { position: fixed; top:12px; left:12px; right:12px; z-index:3000; }
    .search-bar input { width:100%; padding:12px; font-size:16px; border-radius:12px; border:1px solid #ccc; }

    .user-icon{position:relative;}
    .user-dot{width:14px;height:14px;background:#2563eb;border-radius:50%;position:absolute;top:13px;left:13px;border:3px solid #fff;}
    .user-arrow{width:0;height:0;border-left:6px solid transparent;border-right:6px solid transparent;border-bottom:14px solid #2563eb;position:absolute;top:-2px;left:14px;transform-origin:50% 18px;}
    .route-info{position:fixed;left:12px;right:12px;bottom:calc(90px + env(safe-area-inset-bottom));background:#fff;border-radius:12px;padding:12px;box-shadow:0 4px 12px rgba(0,0,0,.25);z-index:2600;font-size:14px;}
    .route-info button{margin-top:8px;width:100%;padding:10px;border:none;border-radius:8px;background:#2563eb;color:#fff;font-size:15px;}
    .marker-highlight{filter:drop-shadow(0 0 6px #2563eb);} 
</style>
</head>
<body>

<div id="map"></div>

<div class="search-bar hidden" id="searchBar">
  <input id="searchInput" placeholder="üîç T√¨m t√™n ho·∫∑c SƒêT" />
</div>

<div class="ui-layer">
  <button id="btnLocate">üìç</button>
  <button id="btnSearch">üîç</button>
  <button id="btnList">üìã</button>
  <button id="btnTrash">üóëÔ∏è</button>
  <button id="btnExport">‚¨ÜÔ∏è</button>
  <button id="btnImport">‚¨áÔ∏è</button>
</div>

<div id="saveSheet" class="bottom-sheet hidden">
  <h3>üìå L∆∞u ƒëi·ªÉm giao h√†ng</h3>
  <input id="inputName" class="sheet-input" placeholder="T√™n kh√°ch h√†ng" />
  <input id="inputPhone" class="sheet-input" placeholder="S·ªë ƒëi·ªán tho·∫°i" />
  <div class="sheet-actions">
    <button class="btn-cancel" id="btnCancel">H·ªßy</button>
    <button class="btn-save" id="btnSave">L∆∞u</button>
  </div>
</div>

<div id="listSheet" class="bottom-sheet hidden"></div>
<div id="trashSheet" class="bottom-sheet hidden"></div>
<div id="routeInfo" class="route-info hidden"></div>

<script>
/******** MAP ********/
const map = L.map('map').setView([10.762622,106.660172],15);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ maxZoom:19 }).addTo(map);

/******** DB (FIX VERSION >= EXISTING) ********/
const db = new Dexie('shipperDB');
// IMPORTANT: version MUST be >= existing IndexedDB version to avoid VersionError
// User DB already at version 200, so we keep it stable here

db.version(200).stores({ locations:'++id,name,phone,lat,lng,deleted' });

/******** DOM ********/
const saveSheet=document.getElementById('saveSheet');
const listSheet=document.getElementById('listSheet');
const trashSheet=document.getElementById('trashSheet');
const inputName=document.getElementById('inputName');
const inputPhone=document.getElementById('inputPhone');
const btnCancel=document.getElementById('btnCancel');
const btnSave=document.getElementById('btnSave');
const btnLocate=document.getElementById('btnLocate');
const btnSearch=document.getElementById('btnSearch');
const btnList=document.getElementById('btnList');
const btnTrash=document.getElementById('btnTrash');
const btnExport=document.getElementById('btnExport');
const btnImport=document.getElementById('btnImport');
const searchBar=document.getElementById('searchBar');
const searchInput=document.getElementById('searchInput');

let markers = {};
let routeMeta = null;
let tempLatLng = null;
let lastSearchId = null;

function closeAll(){
  saveSheet.classList.add('hidden');
  listSheet.classList.add('hidden');
  trashSheet.classList.add('hidden');
  searchBar.classList.add('hidden');
}

/******** ADD LOCATION ********/
map.on('click', e => {
  tempLatLng = e.latlng;
  closeAll();
  saveSheet.classList.remove('hidden');
});

btnSave.onclick = async () => {
  if (!inputName.value || !inputPhone.value) return alert('Nh·∫≠p ƒë·ªß');
  const id = await db.locations.add({
    name: inputName.value,
    phone: inputPhone.value,
    lat: tempLatLng.lat,
    lng: tempLatLng.lng,
    deleted: 0
  });
  markers[id] = L.marker([tempLatLng.lat, tempLatLng.lng]).addTo(map);
  inputName.value = '';
  inputPhone.value = '';
  saveSheet.classList.add('hidden');
};

btnCancel.onclick = () => saveSheet.classList.add('hidden');

/******** LIST ********/
btnList.onclick = async () => {
  if (!listSheet.classList.contains('hidden')) { listSheet.classList.add('hidden'); return; }
  closeAll();
  listSheet.innerHTML = '<h3>üìã Danh s√°ch</h3>';
  const items = await db.locations.where('deleted').equals(0).toArray();
  for (const it of items) {
    const d = document.createElement('div');
    d.className = 'list-item';
    d.innerHTML = `<b>${it.name}</b>${it.phone}<div class="list-actions"><button>Xem</button><button>X√≥a</button></div>`;
    const [viewBtn, delBtn] = d.querySelectorAll('button');
    viewBtn.onclick = () => {
      lastSearchId = it.id;
      clearRoute();
      highlightMarker(it.id);
      map.flyTo([it.lat,it.lng],18);
      if(userMarker){ updateSnapRoute(userMarker.getLatLng()); }
    };
    delBtn.onclick = async () => { await db.locations.update(it.id,{deleted:1}); markers[it.id]?.remove(); delete markers[it.id]; btnList.onclick(); };
    listSheet.appendChild(d);
  }
  listSheet.classList.remove('hidden');
};

/******** TRASH ********/
btnTrash.onclick = async () => {
  if (!trashSheet.classList.contains('hidden')) { trashSheet.classList.add('hidden'); return; }
  closeAll();
  trashSheet.innerHTML = '<h3>üóëÔ∏è Th√πng r√°c</h3>';
  const items = await db.locations.where('deleted').equals(1).toArray();
  for (const it of items) {
    const d = document.createElement('div');
    d.className = 'list-item';
    d.innerHTML = `<b>${it.name}</b>${it.phone}<div class="list-actions"><button>Kh√¥i ph·ª•c</button><button>X√≥a</button></div>`;
    const [restoreBtn, delBtn] = d.querySelectorAll('button');
    restoreBtn.onclick = async () => {
      await db.locations.update(it.id,{deleted:0});
      // FIX: lu√¥n t·∫°o l·∫°i marker n·∫øu ƒë√£ b·ªã remove tr∆∞·ªõc ƒë√≥
      if(!markers[it.id]){
        markers[it.id] = L.marker([it.lat,it.lng]).addTo(map);
      } else if(!map.hasLayer(markers[it.id])){
        markers[it.id].addTo(map);
      }
      btnTrash.onclick();
    };
    delBtn.onclick = async () => { await db.locations.delete(it.id); btnTrash.onclick(); };
    trashSheet.appendChild(d);
  }
  trashSheet.classList.remove('hidden');
};

/******** SEARCH ********/
btnSearch.onclick = () => searchBar.classList.toggle('hidden');
searchInput.oninput = async () => {
  const q = searchInput.value.trim().toLowerCase();
  if (q.length < 2) return;
  const results = await db.locations.filter(i => !i.deleted && (i.name.toLowerCase().includes(q) || i.phone.replace(/\D/g,'')===q.replace(/\D/g,''))).toArray();
  if (!results.length) return;
  if (results[0].id === lastSearchId) return;
  clearRoute(); lastSearchId = results[0].id; highlightMarker(lastSearchId);
  map.flyTo([results[0].lat, results[0].lng], 18);
};

/******** EXPORT / IMPORT ********/
btnExport.onclick = async () => {
  const blob = new Blob([JSON.stringify(await db.locations.toArray(), null, 2)], { type:'application/json' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'shipper-data.json'; a.click();
};

btnImport.onclick = () => {
  const input = document.createElement('input'); input.type='file'; input.accept='application/json';
  input.onchange = async e => {
    const data = JSON.parse(await e.target.files[0].text());
    await db.locations.clear(); Object.values(markers).forEach(m=>m.remove()); markers={};
    for (const it of data) { const id = await db.locations.add(it); if (!it.deleted) markers[id]=L.marker([it.lat,it.lng]).addTo(map); }
  };
  input.click();
};

/******** USER LOCATION + SNAP ROUTE ********/
let userMarker=null, routeLine=null, lastPos=null;
const userIcon = L.divIcon({ className:'user-icon', html:'<div class="user-dot"></div><div class="user-arrow"></div>', iconSize:[40,40], iconAnchor:[20,20] });

function bearing(a,b){ const toRad=d=>d*Math.PI/180; const y=Math.sin(toRad(b.lng-a.lng))*Math.cos(toRad(b.lat)); const x=Math.cos(toRad(a.lat))*Math.sin(toRad(b.lat))-Math.sin(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.cos(toRad(b.lng-a.lng)); return (Math.atan2(y,x)*180/Math.PI+360)%360; }
function rotateArrow(angle){ const arrow=document.querySelector('.user-arrow'); if(arrow) arrow.style.transform=`rotate(${angle}deg)`; }

function clearRoute(){ if(routeLine){ map.removeLayer(routeLine); routeLine=null; } routeMeta=null; document.getElementById('routeInfo').classList.add('hidden'); }
function highlightMarker(id){ Object.values(markers).forEach(m=>m.getElement()?.classList.remove('marker-highlight')); const el=markers[id]?.getElement(); if(el) el.classList.add('marker-highlight'); }

async function updateSnapRoute(userLatLng){ if(!lastSearchId) return; const m=markers[lastSearchId]; if(!m) return; const t=m.getLatLng(); const url=`https://router.project-osrm.org/route/v1/driving/${userLatLng.lng},${userLatLng.lat};${t.lng},${t.lat}?overview=full&geometries=geojson`; try{ const r=await fetch(url); const d=await r.json(); if(!d.routes?.length) return; routeMeta = { distance: d.routes[0].distance, duration: d.routes[0].duration, target: t }; showRouteInfo(); const coords=d.routes[0].geometry.coordinates.map(c=>[c[1],c[0]]); if(!routeLine) routeLine=L.polyline(coords,{color:'#2563eb',weight:5}).addTo(map); else routeLine.setLatLngs(coords); }catch(e){} }

let firstLocate = true;
function ensureUserMarkerVisible(){ if(userMarker && !map.hasLayer(userMarker)) userMarker.addTo(map); }
if(navigator.geolocation){ navigator.geolocation.watchPosition(p=>{ const ll=L.latLng(p.coords.latitude,p.coords.longitude); if(!userMarker) userMarker=L.marker(ll,{icon:userIcon}).addTo(map); else userMarker.setLatLng(ll); if(lastPos) rotateArrow(bearing(lastPos,ll)); lastPos=ll; updateSnapRoute(ll); ensureUserMarkerVisible(); if(firstLocate){ map.flyTo(ll,18); firstLocate=false; } },null,{enableHighAccuracy:true,maximumAge:1000}); }

function showRouteInfo(){ if(!routeMeta) return; const box=document.getElementById('routeInfo'); const km=(routeMeta.distance/1000).toFixed(2); const min=Math.round(routeMeta.duration/60); box.innerHTML=`üöó <b>${km} km</b> ‚Ä¢ ‚è± ${min} ph√∫t<button id=\"btnNav\">B·∫Øt ƒë·∫ßu d·∫´n ƒë∆∞·ªùng</button><button id=\"btnCancelNav\" style=\"margin-top:6px;background:#e5e7eb;color:#000;\">H·ªßy d·∫´n ƒë∆∞·ªùng</button>`; box.classList.remove('hidden'); document.getElementById('btnNav').onclick=()=>{ const u=userMarker.getLatLng(); const t=routeMeta.target; window.open(`https://www.google.com/maps/dir/?api=1&origin=${u.lat},${u.lng}&destination=${t.lat},${t.lng}&travelmode=driving`,'_blank'); }; document.getElementById('btnCancelNav').onclick=()=>{ clearRoute(); lastSearchId=null; }; }

btnLocate.onclick = () => navigator.geolocation?.getCurrentPosition(p=>map.flyTo([p.coords.latitude,p.coords.longitude],18));

console.assert(map,'map ok');
console.assert(db.locations,'db ok');

/******** RESTORE MARKERS ON LOAD (FIX RELOAD / GITHUB BUG) ********/
(async function restoreOnLoad(){
  const items = await db.locations.where('deleted').equals(0).toArray();
  items.forEach(it=>{
    if(!markers[it.id]){
      markers[it.id] = L.marker([it.lat,it.lng]).addTo(map);
    }
  });
  setTimeout(()=>map.invalidateSize(),300);
})();
</script>
</body>
</html>
